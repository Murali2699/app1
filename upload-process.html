<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Payment Automation Dashboard</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <!-- Favicons -->
    <link href="assets/img/tn_logo.png" rel="icon">
    <link href="assets/img/tn_logo.png" rel="apple-touch-icon">
    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> -->
    <link rel="stylesheet" href="assets/vendor/sweetalert2/css/sweetalert.min.css" />
    <link rel="stylesheet" href="assets/vendor/sweetalert2/css/sweetalert2.min.css" />
    <!-- <link rel="stylesheet" href="assets/vendor/toggle/bootstrap-toggle.min.css" /> -->
    <!-- CSS File --> 
    <link href="assets/css/style.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css"> -->
    <script src="assets/components/official_header.js" type="text/javascript" defer></script>
  </head>
  <body>

    <style>
        span#pending_approval_processing {
        position: absolute;
        top: 4.5rem;
        left: 15rem;
        width: auto;
        }
        span#progress_strat {
        position: absolute;
        top: 4.5rem;
        left: 15rem;
        width: auto;
        }
        .text-danger {
        font-size: 13px;
        font-weight: bold;
        }
        div.pamentDateGroup {
        position: absolute;
        right: 19rem;
        margin-top: -19px;
        font-weight: bold;
        font-size: smaller;
        width: 244px;
        }
        span#paymentDate_error {
          position: absolute;
          bottom: -22px;
          }
      .bi-check-lg::before,.bi-x-lg::before {
        font-size: 2rem;
      }
    </style>
    <!-- ======= Header & sidemenu ======= -->
    <official-header-component></official-header-component>
    <div id="preloader" style="display: none;"></div>
    <!-- End Sidebar-->
    <main id="main" class="main">
      <!-- Dashboard view starts -->
      <section>
        <div class="container-fluid">
            <div class="card">
                <div class="row p-2">
                    <div class="col">
                        <button class="btn btn-success" onclick="deduplicateValidate();" type="button">Deduplication Validate</button>
                    </div>
                    <div class="col">
                        <button class="btn btn-success" type="button" id="transferToPaymetProcessBtn" disabled onclick="showTranferPaymentProcess();">Transfer to Payment Process</button>
                    </div>
                    <div class="col"></div>
                    <div class="col"></div>
                </div>
            </div>
        </div>
      </section>
    </main>
    <!-- End #main -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>TNeGA</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        Designed & Developed by <a href="https://tngis.tn.gov.in/" target="_blank">TNeGA</a>
      </div>
    </footer>
    <!-- End Footer -->
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
    <!-- Delete modal starts -->

    



    <!-- function list -->

    <div class="modal fade deduplicationValidateFunctionsList" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="bi bi-file-earmark-person"></i><span id="popup_head"></span> Validation Status</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body py-2">
            <div class="row scheme-data mb-2">
              <div class="table-responsive">
                <table class="table mt-3 w-100" class="table table-striped w-100 no-footer dataTable mt-3" id="deduplicationValidateFunctionsList" aria-describedby="deduplicationValidateFunctionsList_info">
                  <thead>
                    <tr>
                      <th scope="col"  class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateFunctionsList" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">S.No</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateFunctionsList" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Validation Type</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateFunctionsList" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Validation Status</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>1</td>
                      <td>Duplicate Aadhaar</td>
                      <td> <span id="function_1"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span> </td>
                    </tr>
                    <tr>
                      <td>2</td>
                      <td>Duplicate Bank Account</td>
                      <td><span id="function_2"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>
                    <tr>
                      <td>3</td>
                      <td>Invalid IIN (or) IFSC</td>
                      <td><span id="function_3"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>
                    <tr>
                      <td>4</td>
                      <td>Invalid Aadhaar</td>
                      <td><span id="function_4"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>
                    <tr>
                      <td>5</td>
                      <td>Invalid Account</td>
                      <td><span id="function_5"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>
                    <tr>
                      <td>6</td>
                      <td>Invalid Beneficiary Name</td>
                      <td><span id="function_6"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>
                    <tr>
                      <td>7</td>
                      <td>Duplicate Benificiary</td>
                      <td><span id="function_7"><div class="spinner-grow text-primary" role="status"><span class="visually-hidden">Loading...</span></div></span></td>
                    </tr>                    
                  </tbody>
                </table>
              </div>
            </div>
            <div class="row mb-2 dashboard">
              
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="viewSummary()" data-bs-dismiss="modal" id="deduplicationBtn">View Duplication Summary</button>
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <!-- function list end -->


   


    <!-- view data starts deduplication Validaet Summary-->
    <div class="modal fade deduplicationValidateSummary" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="bi bi-file-earmark-person"></i><span id="popup_head"></span> Deduplication Validate Summary</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body py-2">
            <div class="row scheme-data mb-2">
              <div class="table-responsive">
                <table class="table mt-3 w-100" class="table table-striped w-100 no-footer dataTable mt-3" id="deduplicationValidateSummary" aria-describedby="deduplicationValidateSummary_info">
                  <thead>
                    <tr>
                      <th scope="col"  class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">S.No</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Scheme Name</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Subscheme Name</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">District Name</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Taluk Name</th>

                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Year Month</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Duplicate Benificiary</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Duplicate Aadhaar</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Duplicate Account</th>

                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Invalid Beneficiary Name</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Invalid IIN (or) IFSC</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Duplicate Aadhaar</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Duplicate Account</th>
                      <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="deduplicationValidateSummary" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Download</th>
                    </tr>
                  </thead>
                  <tbody>
                    
                  </tbody>
                </table>
              </div>
            </div>
            <div class="row mb-2 dashboard">
              
            </div>
          </div>
          <div class="modal-footer">
            <!-- <button type="button" class="btn btn-success" onclick="allTransferPermissionEnable()" data-bs-dismiss="modal">Enable To Transfer</button> -->
            <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
          </div>
        </div>
      </div>
    </div>
    <!-- view data ends -->


        <!-- view data starts -->
        <div class="modal fade transferPaymentProcess" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
              <div class="modal-content">
                <div class="modal-header py-2">
                  <h1 class="modal-title fs-5" id="exampleModalLabel"><i class="bi bi-file-earmark-person"></i><span id="popup_head"></span> Transfer to Payment Process</h1>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body py-2">
                  <div class="row scheme-data mb-2">
                    <div class="table-responsive">
                      <table class="table mt-3 w-100" class="table table-striped w-100 no-footer dataTable mt-3" id="transferPaymentProcess" aria-describedby="transferPaymentProcess_info">
                        <thead>
                          <tr>
                            <th scope="col"  class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">S.No</th>
                            <!-- <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Scheme</th> -->
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">District</th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Taluk </th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Transfer Payment Process Status</th>
                            <!-- <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="2" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Year Month</th> -->
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="2" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">APB </th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="2" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">ACH </th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="2" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Total</th>
                          </tr>
                          <tr>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Count</th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Amount</th>                    
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Count</th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Amount</th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Count</th>
                            <th scope="col" class="sorting sorting_asc" tabindex="0" aria-controls="transferPaymentProcess" rowspan="1" colspan="1" aria-label="S.No: activate to sort column descending" style="width: 37px;" aria-sort="ascending">Amount</th>
                            
                          </tr>
                        </thead>
                        <tbody>
                          
                        </tbody>
                      </table>
                    </div>
                  </div>
                  <div class="row mb-2 dashboard">
                    
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-success" onclick="TransferPaymentProcessInziated();" id="transferBtn">Transfer</button>
                  <!-- <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button> -->
                </div>
              </div>
            </div>
          </div>
          <!-- view data ends -->



    <!-- view crop info ends -->
    <!-- Vendor JS Files -->
    
    <script src="assets/vendor/jquery/jquery.min.js"></script>
    <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/main.js"></script>
    <script type="text/javascript" src="assets/vendor/jquery-validate/js/jquery.validate.min.js"></script>


    <!-- data table -->
    <script src="assets/vendor/datatable/jquery.dataTables.min.js"></script>
    <script src="assets/vendor/datatable/dataTables.bootstrap5.min.js"></script>
    <script type="text/javascript" src="assets/vendor/datatable/js/dataTables.js"></script>
    <script type="text/javascript" src="assets/vendor/datatable/js/dataTables.bootstrap4.js"></script>
    <script src="assets/vendor/datatables-buttons/js/dataTables.buttons.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/jszip.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/pdfmake.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/vfs_fonts.js"></script>
    <script src="assets/vendor/datatables-buttons/js/buttons.html5.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/buttons.print.min.js"></script>
    <script src="assets/vendor/datatables-buttons/js/buttons.colVis.min.js"></script>
    <script src="assets/vendor/sweetalert2/js/sweetalert.min.js"></script>
    <script src="assets/vendor/sweetalert2/js/sweetalert2.all.min.js"></script>
    <script src="assets/vendor/toggle/bootstrap-toggle.min.js"></script>
    <script src="assets/js/global.js"></script>
    <script src="assets/js/alpinejs_3_10_2.min.js" defer></script>
    <script src="assets/lang/reports.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js'></script>
    <!-- data table -->
    <!-- Main JS File -->
    
    <script src="assets/js/global.js"></script>
    <script src="assets/js/base64tojson.js"></script>
    <script src="assets/js/crypto-js.js"></script>
    <script src="assets/js/aes.js"></script>

    <script type="text/javascript" src="assets/vendor/toastr/toastr.min.js"></script>
    
    <!-- Crypto js -->
    <script src="assets/vendor/encryption/crypto-js.min.js"></script>
    <!-- Encryption js -->
    <script src="assets/vendor/encryption/Encryption.js"></script>
    <script src="assets/vendor/sweetalert2/js/sweetalert2.all.min.js"></script>
    <script src="assets/scripts/xlsx.full.min.js"></script>
    
    
 
 <script type="text/javascript">
  

var url = window.location.href;
var page_url = url.split('/');
var page = page_url[4];

var userDataString = getCookie('payment_official');
userDataString = JSON.parse(userDataString);
$(document).ready(function () {
  $(document).on({
         ajaxStart: function () {
           $('#preloader').show();
          //  console.log('preloader is show');
         },
         ajaxStop: function () {
           $('#preloader').hide();
          //  console.log('preloader is show');
         }
       });

  $('.official').each(function (i, obj) {
    var href = obj.getAttribute("href");
    if (href == page) {
      obj.classList.add('active');
    } else {
      obj.classList.remove('active');
    }
  });
//   $('#preloader').hide();
});
  var userDataString = getCookie('payment_official');
  if (!userDataString) {
    $('#preloader').show();
    window.location.href = "login.html";
  }

  userDataString = JSON.parse(userDataString);
  $('#official_username').text(userDataString['first_name']);
  $('#UserID').val(userDataString['user_id']);
  window.loginUser_id = userDataString['user_id'];
  reloID = userDataString['role_id'];
  roleBasedPageAllow(loginUser_id,reloID);



  

function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        return cookie.substring(name.length + 1);
      }
    }
    return null;
  }




function getCookie(name) {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.startsWith(name + '=')) {
        return cookie.substring(name.length + 1);
      }
    }
    return null;
  }

  $('#deduplicationBtn').hide();
  window.localStorage.setItem('deDuplicatePopup',0);

function deduplicateValidate(){
  let deDuplicationPopupStatus =  window.localStorage.getItem('deDuplicatePopup');
  if(deDuplicationPopupStatus === 1){
    $('.deduplicationValidateFunctionsList').modal('show');
    return false;
  }else if(deDuplicationPopupStatus === 2){
    $('.deduplicationValidateSummary').modal('show');
    return false;
  }else{
      var userDataString = getCookie('payment_official');
      userDataString = JSON.parse(userDataString);
      window.loginUser_id = userDataString['user_id'];

      $('.deduplicationValidateFunctionsList').modal('show');

      var caseList = ['fn_validation_duplicateaadhaar','fn_validation_duplicatebankaccount','fn_validation_invalidiinorifsc','fn_validation_invalidaadhaar','fn_validation_invalidaccount','fn_validation_invalidbeneficiaryname','fn_validation_duplicatebenificiary'];

      let totalFunction = 7;
      let startFalseFunction = 0;
      caseList.length

      caseList.forEach(fnCase => {
        $.ajax({
          url: APIURL + 'checkDuplicationValues',
          method: 'POST',
          headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
          data: { case: fnCase },
          dataType: 'json',
          success: function (response) {
              let output = response.data;
              if(output.result==false){
                $('#'+output.activeId).html(`<i class="bi bi-check-lg text-success"></i>`);
                window.localStorage.setItem('deDuplicatePopup',1);
                startFalseFunction++;
              }else{
                $('#'+output.activeId).html(`<i class="bi bi-x-lg text-danger"></i>`);
                $('#deduplicationBtn').show();
              }
              if(totalFunction == startFalseFunction){
                window.localStorage.setItem('deDuplicatePopup',0);
                $('#transferToPaymetProcessBtn').prop('disabled',false);
              }
          },
          error: function (xhr, status, error) {
              console.log("Error:", error);
          }
        });
        // $('#deduplicationBtn').prop('disabled',false);
        $('#preloader').hide();
      });
  }
}


function viewSummary(){
      window.localStorage.setItem('deDuplicatePopup',2);

      $('.deduplicationValidateSummary').modal('show');
      var dataFilters = window.localStorage.getItem('filters');
      var approveStatus = 1;

      $('#preloader').show();
      $('#deduplicationValidateSummary').DataTable().clear().destroy();
      $('#deduplicationValidateSummary').DataTable({
      "aLengthMenu": [10, 25, 50,100],
      "pageLength": -1,
      "footer": true,
      "dom": 'Bfrtip',
      "buttons": [
      {
          extend: 'csv',
          text: 'CSV',
          filename: 'Payment Lists',
          exportOptions: {
              rows: ':visible', // Export visible rows
              modifier: {
                  selected: null // Export all rows, not just selected
              }
          }
      },
      {
          extend: 'excel',
          text: 'Excel',
          filename: 'Payment Lists' // Set custom filename for Excel
      },
      {
          extend: 'pdf',
          text: 'PDF',
          filename: 'Payment Lists' // Set custom filename for PDF
      }],
      "searching": true,
      "processing": true,
      "serverSide": true,
      "ajax": {
      "url": APIURL + 'fn_payment_validatebenificiaries',
      "type": "POST",
      "headers": { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
      "dataType": "JSON",
      "data": function (data) {
      data.fileters = dataFilters;
      data.approveStatus = approveStatus;
      data.user_id = loginUser_id;
      },
      "beforeSend": function () {
      $('#preloader').show(); // Show the preloader before sending the request
      tblPreloaderEnable('deduplicationValidateSummary');
      },
      "error": function (xhr, error, thrown) {
          Swal.fire({
              icon: "error",
              title: 'Service Error !',
              showConfirmButton: false,
              timer: 2000
          });
      },

      "dataSrc": 'data',
      },
      "columns": [

      // { "data": "checkbox" },
      { "data": "S.No", render: function (data, type, row, meta) {
          return meta.row + meta.settings._iDisplayStart + 1;
          }
      },
      { "data": "scheme_name" },
      { "data": "subscheme_name" },
      { "data": "district_name" },
      { "data": "taluk_name"},
      { "data": "yyyymm" },
      { "data": "duplicatebenificiary"},
      { "data": "duplicateaadhaar"},
      { "data": "duplicateaccount"},
      { "data": "invalidbeneficiaryname"},
      { "data": "invalidiinorifsc"},
      { "data": "invalidaadhaar"},
      { "data": "invalidaccount"},
      { "data": function (data, type, row, meta) {
          return '<a onclick="downloadFileDuplicates('+data.distirict_code+','+data.taluk_code+')" ><span class="btn btn-primary btn-sm"><i class="bi bi-download"></i> Download</span></span>';
          }
      },
      ],
      "aoColumnDefs": [{
      'bSortable': false,
      'aTargets': [0]
      }],
      "drawCallback": function (settings) {
      // Your drawCallback logic goes here
      // For example, updating dropdowns or other elements after the table is drawn
      },
      "initComplete": function (settings, json) {
      $('#preloader').hide();
      buklApproveSummary = json.data;
        if(buklApproveSummary==null){
          allTransferPermissionEnable();
          $('.deduplicationValidateSummary').modal('hide');
        }
      }

      });
}




function allTransferPermissionEnable(){
    $('#transferToPaymetProcessBtn').prop('disabled', false);
}

var bulkTransferPaymentProcessSummary = [];

let transferPaymentProcessApproveStatus = window.localStorage.getItem('transferPaymentProcess');

if(transferPaymentProcessApproveStatus === null){
  window.localStorage.setItem('transferPaymentProcess', 'false');
}

function showTranferPaymentProcess(){
  let transferPaymentProcess = window.localStorage.getItem('transferPaymentProcess');

  if(transferPaymentProcess == 'true'){
    $('.transferPaymentProcess').modal('show');
  }else{
    var userDataString = getCookie('payment_official');
    userDataString = JSON.parse(userDataString);
    window.loginUser_id = userDataString['user_id'];

    $('.transferPaymentProcess').modal('show');
        var dataFilters = window.localStorage.getItem('filters');
        var approveStatus = 1;
        $('#preloader').show();
        
        $('#transferPaymentProcess').DataTable().clear().destroy();
        $('#transferPaymentProcess').DataTable({
        "aLengthMenu": [10, 25, 50,100],
        "pageLength": -1,
        "footer": true,
        "dom": 'Bfrtip',
        "buttons": [
        {
            extend: 'csv',
            text: 'CSV',
            filename: 'Payment Lists',
            exportOptions: {
                rows: ':visible', // Export visible rows
                modifier: {
                    selected: null // Export all rows, not just selected
                }
            }
        },
        {
            extend: 'excel',
            text: 'Excel',
            filename: 'Payment Lists' // Set custom filename for Excel
        },
        {
            extend: 'pdf',
            text: 'PDF',
            filename: 'Payment Lists' // Set custom filename for PDF
        }],
        "searching": true,
        "processing": true,
        "serverSide": true,
        "ajax": {
        "url": APIURL + 'transferPaymentSummaryList',
        "type": "POST",
        "headers": { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
        "dataType": "JSON",
        "data": function (data) {
        data.fileters = dataFilters;
        data.approveStatus = approveStatus;
        data.user_id = loginUser_id;
        },
        "beforeSend": function () {
        $('#preloader').show(); // Show the preloader before sending the request
        tblPreloaderEnable('transferPaymentProcess');
        },
        "error": function (xhr, error, thrown) {
            Swal.fire({
                icon: "error",
                title: 'Service Error !',
                showConfirmButton: false,
                timer: 2000
            });
        },

        "dataSrc": 'data',
        },
        "columns": [

        // { "data": "checkbox" },
        { "data": "S.No", render: function (data, type, row, meta) {
            return meta.row + meta.settings._iDisplayStart + 1;
            }
        },
        // { "data": "scheme_name" },
        { "data": "district_name" },
        { "data": "taluk_name" },
        // { "data": "trackingID"},
        {
        "data": "trackingID",
        "render": function (data, type, row) {
            // Customize the content here
            return '<span id="'+data+'" ><span class="btn btn-warning btn-sm"><i class="bi bi-check2-circle"></i> Waiting For Transfer</span></span>';
        }
        },
        { "data": "apb_count" },
        { "data": "apb_amount"},
        { "data": "ach_count"},
        { "data": "ach_amount"},
        { "data": "total_count"},
        { "data": "total_amount"},
        // Add more columns as needed
        // Example: { "data": "complaint_raised_by" },
        ],
        "aoColumnDefs": [{
        'bSortable': false,
        'aTargets': [0]
        }],
        "drawCallback": function (settings) {
        // Your drawCallback logic goes here
        // For example, updating dropdowns or other elements after the table is drawn
        },
        "initComplete": function (settings, json) {
        $('#preloader').hide(); // Hide the preloader after DataTable initialization
        var districtTalukArr = [];

            json.data.forEach(summary => {
                // Use push to add a new object to the array in each iteration
                districtTalukArr.push({
                "district": summary.district_code,
                "taluk": summary.taluk_code,
                "trackingID" : summary.trackingID,
                "status" : 0
                });
            });

            bulkTransferPaymentProcessSummary = districtTalukArr;

        }
        });
  }
   
}

function downloadFileDuplicates(district_code,taluk_code){
  $('#preloader').show();
  var dataFilters = window.localStorage.getItem('filters');
  $.ajax({
      url: APIURL + 'transferToPaymentProcessDownload',
      method: 'POST',
      headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
      data: {fileters:dataFilters,district_code:district_code,taluk_code:taluk_code},
      dataType: 'json',
      success: function (response) {
        
        exportJsonToExcel(response.data,'Duplicate Beneficiary');
      },
      error: function (xhr, status, error) {
        console.log("Error:", error);
      }
    });
}



function TransferPaymentProcessInziated(){
  // debugger;
  if (bulkTransferPaymentProcessSummary.length > 0) {
      $('#transferBtn').prop('disabled',true);
      const batchSize = 5;
      var  trackingIDArr = bulkTransferPaymentProcessSummary.filter(n => n.status == 0);
      var runningprocess = bulkTransferPaymentProcessSummary.filter(n => n.status == 1);

      var loopcounter = batchSize;
      loopcounter = loopcounter - runningprocess.length;
      
      if (loopcounter > 0)
      {
        if (loopcounter > trackingIDArr.length)
        {
           loopcounter = trackingIDArr.length;
        }
        processBatch(0,loopcounter,trackingIDArr);
      }
  } else {
      Swal.fire({
          icon: "error",
          title: 'Summary is Empty !',
          showConfirmButton: false,
          timer: 2000
      });
  }
}


function processBatch(startIndex, loopcounter, trackingIDArr) {

  var userDataString = getCookie('payment_official');
  userDataString = JSON.parse(userDataString);
  window.loginUser_id = userDataString['user_id'];

  let transferToPaymentUniqId = [];
    // const endIndex = Math.min(startIndex + loopcounter, bulkTransferPaymentProcessSummary.length);

    for (let i = startIndex; i < loopcounter; i++) {

      console.log(trackingIDArr[i]);

      // transferToPaymentUniqId.push(trackingIDArr[i].trackingID);
      $.each( bulkTransferPaymentProcessSummary, function( j, obj ) {
            if(obj.trackingID == trackingIDArr[i].trackingID){              
              obj.status = 1;
            }
          });

      $.ajax({
        url: APIURL+'transferPaymentProcessbulkapprove',
        method: 'POST',
        headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
        data: {district:trackingIDArr[i].district, taluk:trackingIDArr[i].taluk, trackingID:trackingIDArr[i].trackingID, user_id:loginUser_id},
        dataType: 'json',
      });

      updatestatus(trackingIDArr[i].trackingID);
      
      $('#preloader').hide();
    }

    // window.localStorage.setItem('transferPaymentProcessbulkapprove', transferToPaymentUniqId);
    // window.localStorage.setItem('transferPaymentProcess','true');
    // bulkTranferToPaymentStatus();
}


// function processBatch(startIndex, loopcounter, trackingIDArr) {

//   var userDataString = getCookie('payment_official');
//   userDataString = JSON.parse(userDataString);
//   window.loginUser_id = userDataString['user_id'];

//   let transferToPaymentUniqId = [];

//   for (let i = startIndex; i < loopcounter; i++) {
//     transferToPaymentUniqId.push(trackingIDArr[i].trackingID);

//     // Assuming 'self' refers to the Service Worker
//     self.fetch(APIURL + 'transferPaymentProcessbulkapprove', {
//       method: 'POST',
//       headers: {
//         'Content-Type': 'application/json',
//         'X-APP-KEY': config.app_key,
//         'X-APP-NAME': config.app_name,
//       },
//       body: JSON.stringify({
//         district: trackingIDArr[i].district,
//         taluk: trackingIDArr[i].taluk,
//         trackingID: trackingIDArr[i].trackingID,
//         user_id: window.loginUser_id,
//       }),
//     })
//     .then(response => {
//       if (!response.ok) {
//         throw new Error('Network response was not ok');
//       }

//       const contentType = response.headers.get('content-type');
//       if (contentType && contentType.includes('application/json')) {
//         return response.json();
//       } else {
//         // Handle non-JSON response
//         throw new Error('Unexpected content type');
//       }
//     })
//     .then(data => {
//       console.log(data);
//       updatestatus(trackingIDArr[i].trackingID);
//     })
//     .catch(error => {
//       console.error('Error:', error);
//       // Handle the error, possibly by retrying the request or showing a user-friendly message
//     });
//   }

//   // The rest of your logic
// }





function updatestatus(trakingId)
{
  
  $('#preloader').hide();
  $.ajax({
      url: APIURL + 'bulkApprovalStatus',
      method: 'POST',
      headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
      data: { trackingId: trakingId },
      dataType: 'json',
      success: function (response) {
        $('#preloader').hide();
        console.log(trakingId);
        console.log(response);
        let output = response.data[0];
        if (output.status == 2) {
          $('#' + trakingId).html('<span class="btn btn-success btn-sm"><i class="bi bi-check2-circle"></i> Completed</span>');
          $.each( bulkTransferPaymentProcessSummary, function( j, obj ) {
            if(obj.trackingID == trakingId){         
              obj.status = 2;
            }
          });
          TransferPaymentProcessInziated();
        } else {
          $('#' + trakingId).html('<span class="btn btn-info btn-sm">' + output.updated_count + ' On-progress</span>');
          // window.localStorage.setItem('transferPaymentProcess','true');
          setTimeout(() => { updatestatus(trakingId);}, 3000);
        }
      },
      error: function (xhr, status, error) {
        console.log("Error:", error);
      }
    });
    $('#preloader').hide();
}



// function updateStatus(trackingId) {
//   fetch(APIURL + 'bulkApprovalStatus', {
//     method: 'POST',
//     headers: {
//       'Content-Type': 'application/json',
//       'X-APP-KEY': config.app_key,
//       'X-APP-NAME': config.app_name,
//     },
//     body: JSON.stringify({ trackingId: trackingId }),
//   })
//   .then(response => response.json())
//   .then(data => {
//     if (data.status == 2) {
//       self.clients.matchAll().then(clients => {
//         clients.forEach(client => {
//           client.postMessage({ type: 'updateStatusResponse', trackingId, status: 'completed' });
//           console.log('updated status completed', client);
//         });
//       });
//     } else {
//       self.clients.matchAll().then(clients => {
//         clients.forEach(client => {
//           client.postMessage({ type: 'updateStatusResponse', trackingId, status: 'on-progress', updatedCount: data.updated_count });

//           console.log('updated status initiated', client);

//         });
//       });
//       setTimeout(() => { updateStatus(trackingId); }, 3000);
//     }
//   })
//   .catch(error => {
//     console.error('Error:', error);
//   });
// }





function bulkTranferToPaymentStatus() {
  let trackingIDString = window.localStorage.getItem('transferPaymentProcessbulkapprove');
  let trackingIDArr = trackingIDString.split(',').map(Number);

  trackingIDArr.forEach(trackingID => {
    $.ajax({
      url: APIURL + 'bulkApprovalStatus',
      method: 'POST',
      headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
      data: { trackingId: trackingID },
      dataType: 'json',
      success: function (response) {
        console.log(trackingID);
        console.log(response);
        let output = response.data[0];
        if (output.status == 2) {
          $('#' + trackingID).html('<span class="btn btn-success btn-sm"><i class="bi bi-check2-circle"></i> Completed</span>');

          // Remove trackingID from local storage
          trackingIDArr = trackingIDArr.filter(id => id !== trackingID);
          let updatedTrackingIDString = trackingIDArr.join(',');
          console.log('update string in local storage >>', updatedTrackingIDString);
          window.localStorage.setItem('transferPaymentProcessbulkapprove', updatedTrackingIDString);
          window.localStorage.setItem('transferPaymentProcess','false');
        } else {
          $('#' + trackingID).html('<span class="btn btn-info btn-sm">' + output.updated_count + ' On-progress</span>');
          window.localStorage.setItem('transferPaymentProcess','true');
          setTimeout(() => { bulkTranferToPaymentStatus();}, 1000);
        }
      },
      error: function (xhr, status, error) {
        console.log("Error:", error);
      }
    });
  });
}



function tblPreloaderEnable(tableName){
      var processingDiv = document.getElementById(tableName+'_processing');
      var displayStatus = window.getComputedStyle(processingDiv).display;
      if (displayStatus === 'block') {
      $('#'+tableName+'_processing').html(`<div id="preloader"></div>`);
      } else {
        $('#'+tableName+'_processing').text(`<div id="preloader"></div>`);
      }
}


function generateUniqueId() {
    const timestamp = new Date().getTime();
    return `${timestamp}`;
}







function exportJsonToExcel(jsonData, file_name) {
  var data = jsonData.map(obj => Object.values(obj));
  var ws = XLSX.utils.aoa_to_sheet([Object.keys(jsonData[0])].concat(data));
  var wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
  var binaryData = XLSX.write(wb, { bookType: 'xlsx', bookSST: true, type: 'binary' });
  var blob = new Blob([s2ab(binaryData)], { type: 'application/octet-stream' });
  saveAs(blob, file_name + '.xlsx');
  $('#preloader').hide();
}

function s2ab(s) {
  var buf = new ArrayBuffer(s.length);
  var view = new Uint8Array(buf);
  for (var i = 0; i != s.length; ++i) view[i] = s.charCodeAt(i) & 0xFF;
  return buf;
}

function convertJsonToCsv(jsonData,filename) {
    // Extract column headers from the first object
    let columns = Object.keys(jsonData[0]);

    // Create CSV content
    let csvContent = [
        columns.join(','), // Header row
        ...jsonData.map(obj => columns.map(col => obj[col]).join(',')) // Data rows
    ].join('\n');

    // return csvContent;

    let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    let link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.setAttribute('download', filename+'.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}


</script>

</body>
</html>