<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Payment Automation Dashboard</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <!-- Favicons -->
    <link href="assets/img/tn_logo.png" rel="icon">
    <link href="assets/img/tn_logo.png" rel="apple-touch-icon">
    <!-- Google Fonts -->
    <link href="https://fonts.gstatic.com" rel="preconnect">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">
    <!-- Vendor CSS Files -->
    <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"> -->
    <link rel="stylesheet" href="assets/vendor/sweetalert2/css/sweetalert.min.css" />
    <link rel="stylesheet" href="assets/vendor/sweetalert2/css/sweetalert2.min.css" />
    <!-- <link rel="stylesheet" href="assets/vendor/toggle/bootstrap-toggle.min.css" /> -->
    <!-- CSS File --> 
    <link href="assets/css/style.css" rel="stylesheet">
    <script src="assets/components/official_header.js" type="text/javascript" defer></script>
    <!-- <link rel="stylesheet" href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css"> -->
    <style type="text/css">
      .card-green-text {
      /* background-color: #008000; */
      background-color: #6eba6e !important;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      }
      .card-lg-blue-text {
        background-color: #2c93b4 !important;
        color: #fff;
        font-size: 14px;
        font-weight: bold;
      }
      .card-lg-orange-text {
        background: #c09012 !important;
        color: #fff;
        font-size: 14px;
        font-weight: bold;
      }
      .card-green-blue
      {
      /*  background-color: #5f14d3;*/
      background-color: #8e63d0 !important;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      }
      .lbl-txt {
      font-weight: 600;
      color: #012970;
      }
      .cus-grid th {
      vertical-align: middle;
      } 
      .bg-card-blue {
      /* background-color: #008000; */
      background-color: #050818 !important;
      color: #fff;
      font-size: 14px;
      font-weight: bold;
      }
      #accordionExample .accordion-button:not(.collapsed)::after, .accordion-button::after {
        filter: invert(1) grayscale(100%) brightness(200%) !important;
    } 
    div#importing_status {
    position: absolute;
    margin-left: -126px;
    margin-top: 1rem;
    }
    span.help-inline {
      position: relative;
      top: 0.4rem;
    }
    .col-md-3{
      margin-bottom: 0.9rem;
    }
    </style>
  </head>
  <body>
     <!-- ======= Header & sidemenu ======= -->
     <official-header-component></official-header-component>
     <div id="preloader"></div> 
     <!-- End Sidebar-->
    <main id="main" class="main">
      <!-- Dashboard view starts -->
      <section>
        <div class="container-fluid">
          <div class="card mb-1">
            <form method="POST" enctype="multipart/form-data" id="beneficiaryUploadForm">
              <div class="card-body pb-0 pt-2">
                <div class="accordion" id="accordionExample">
                  <div class="accordion-item">
                    <h2 class="accordion-header">
                      <button style="    background: linear-gradient(to right, rgb(44 43 88), rgb(34 25 111)) !important;
    color: #fff !important;" class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        <i class="bi bi-upload"></i>  <span class="px-2">Beneficiaries Upload</span>
                      </button>
                    </h2>
                    <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">
                      <div class="accordion-body w-100">
                          <div class="row mb-2 boxflex">
                  <!-- <h5 class="card-title pb- mb-0"><i class="bi bi-upload"></i>  Beneficiaries Upload</h5> -->
                  <div class="col-md-3">
                    <label for="ddl_scheme_cate" class="form-label fw-bold">Scheme category</label>
                    <select class="form-select" id="ddl_scheme_cate" name="ddl_scheme_cate">
                      <option value="">--All--</option>
                      <option value="">Scheme category 1</option>
                      <option value="">Scheme category 2</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_scheme_code" class="form-label fw-bold">Scheme Code</label>
                    <select class="form-select" id="ddl_scheme_code" name="ddl_scheme_code">
                      <option value="">--Select--</option>
                      <option value="0212">0212</option>
                      <option value="0209">0209</option>
                      <option value="0219">0219</option>
                      <option value="0100">0100</option>
                      <option value="0207">0207</option>
                      <option value="0221">0221</option>
                      <option value="0208">0208</option>
                      <option value="0001">0001</option>
                      <option value="0220">0220</option>
                      <option value="0211">0211</option>
                      <option value="0218">0218</option>
                      <option value="0213">0213</option>
                      <option value="0206">0206</option>
                      <option value="0210">0210</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_scheme_name" class="form-label fw-bold">Scheme Name</label>
                    <select class="form-select" id="ddl_scheme_name" name="ddl_scheme_name">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_sub_scheme" class="form-label fw-bold">Sub Scheme Name</label>
                    <select class="form-select" id="ddl_sub_scheme" name="ddl_sub_scheme">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_department" class="form-label fw-bold">Department</label>
                    <select class="form-select" id="ddl_department" name="ddl_department">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_sub_department" class="form-label fw-bold">Sub Department</label>
                    <select class="form-select" id="ddl_sub_department" name="ddl_sub_department">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                </div>
                <hr>
                <div class="row boxflex">
                  <div class="col-md-3">
                    <label for="ddl_district" class="form-label fw-bold">District</label>
                    <select class="form-select" id="ddl_district" name="ddl_district">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="ddl_taluk" class="form-label fw-bold">Taluk</label>
                    <select class="form-select" id="ddl_taluk" name="ddl_taluk">
                      <option value="">--Select--</option>
                    </select>
                  </div>
                </div>
                <hr>
                <div class="row mb-2 boxflex">
                  <!-- <div class="col-md-3">
                    <label class="form-label fw-bold" for="dayWeekMonthFilter">Payment Period</label>
                    <select name="dayWeekMonthFilter" id="dayWeekMonthFilter" class="form-select">
                      <option value="" disabled="" selected="">Select Payment Period</option>
                      <option value="1">Today</option>
                      <option value="2">This Week</option>
                      <option value="3">This Month</option>
                      <option value="0">Custom Date Range</option>
                    </select>
                  </div> -->
                  <div class="col-md-3" id="from_date_col">
                    <label for="ddl_year" class="form-label fw-bold">Year</label> 
                    <!-- <input type="date" name="from_date" id="from_date" class="form-control form-control-sm"> -->
                    <select class="form-select" id="ddl_year" name="ddl_year">
                      <option value="">--All--</option>
                      <!-- <option value="2023">2023</option> -->
                      <option value="2024">2024</option>
                      <option value="2025">2025</option>
                      <option value="2026">2026</option>
                      <option value="2027">2027</option>
                      <option value="2028">2028</option>
                      <option value="2029">2029</option>
                      <option value="2030">2030</option>
                      <option value="2031">2031</option>
                      <option value="2032">2032</option>
                    </select>
                  </div>
                  <div class="col-md-3" id="to_date_col">
                    <label for="ddl_month" class="form-label fw-bold">Month</label>
                    <select class="form-select" id="ddl_month" name="ddl_month">
                      <option value="">--All--</option>
                      <option value="01">Jan</option>
                      <option value="02">Feb</option>
                      <option value="03">Mar</option>
                      <option value="04">Apr</option>
                      <option value="05">May</option>
                      <option value="06">Jun</option>
                      <option value="07">Jul</option>
                      <option value="08">Aug</option>
                      <option value="09">Sep</option>
                      <option value="10">Oct</option>
                      <option value="11">Nov</option>
                      <option value="12">Dec</option>
                    </select>
                  </div>
                </div>
                <div class="row mb-2 boxflex">
                  <div class="col-md-3" > 
                    <label for="beneficiary_csv_file" class="form-label fw-bold">Beneficiaries (<small class="text-danger" style="font-weight: 600;"> Maximum file upload size is 200MB </small>)</label>
                    <input type="file" class="form-control" name="beneficiary_csv_file" id="beneficiary_csv_file" accept=".csv"> 
                  </div>
                  <div class="col-md-3" > 
                    <button class="btn btn-success cbtn mt-4" type="submit" id="uploadBtn"><i class="bi bi-upload"></i> Upload</button>
                  </div>
                  <div class="col-md-6" >
                    <div class="row align-items-center">
                      <div class="col" id="importing_status">
                        
                      </div>
                      <div class="col">
                        <a href="#" class="float-end btn btn-primary btn-block mb-2 cbtn mt-4" onclick="downloadFile()">
                            <i class="bi bi-download"></i> Download Template
                        </a>
                      </div>
                    </div>
                    
                    
                  </div>
                </div>
              </div>
              <input type="hidden" name="approvelpayment" id="approvelpayment">
              <input type="hidden" name="user_id" id="UserID">
                      </div>
                    </div>
                  </div>
                </div>
            </form>
          </div>
          <div class="card mb-1 mt-4" id="div_report_tbl">
            <div class="card-body">
              <h5 class="card-title mt-3 mb-0"><i class="bi bi-check2-circle"></i> Upload Confirmation</h5>
              <div class="row">
                <div class="col-lg-3 mt-2">
                  <div class="input-group mb-1">
                    <span class="input-group-text" id="basic-addon1"><i class="bi bi-search"></i></span>
                    <input type="text" class="form-control" placeholder="Search..." aria-label="Username" aria-describedby="basic-addon1">
                  </div>
                </div>
                <!-- <div class="col-lg-3 mt-2 float-end mb-2">
                  <a href="#" class="btn btn-primary cbtn"><i class="bi bi-file-earmark-excel"></i> csv</a>
                  <a href="#" class="btn btn-primary mx-2 cbtn"><i class="bi bi-file-earmark-pdf"></i> pdf</a>
                </div> -->
              </div>
              <div class="col-lg-12 mt-2 clear-both" style="    clear: both;">
                <div class="table-responsive cus-grid">
                  <table class="table table-striped w-100 no-footer dataTable mt-3" id="tblBeneficiariesUpoloadList" aria-describedby="tblBeneficiariesUpoloadList_info">
                    <thead>
                      <tr>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" rowspan="2">S.No</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" rowspan="2">District</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col"  rowspan="2">Taluk</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" rowspan="2">Year</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" rowspan="2">Month</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" colspan="2" class="bg-card-blue">APB</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" colspan="2" class="card-green-blue">ACH</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" colspan="2">Total</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" rowspan="2">Action</th>
                      </tr>
                      <tr>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" class="bg-card-blue">Count</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" class="bg-card-blue">Amount</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" class="card-green-blue">Count</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col" class="card-green-blue">Amount</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Count</th>
                        <th  tabindex="0" aria-controls="tblBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
          <!-- END: list card end here -->
          <!-- START: modal popup -->
          <!-- Button trigger modal -->
        </div>
      </section>
    </main>
    <!-- End #main -->
    <!-- ======= Footer ======= -->
    <footer id="footer" class="footer">
      <div class="copyright">
        &copy; Copyright <strong><span>TNeGA</span></strong>. All Rights Reserved
      </div>
      <div class="credits">
        Designed & Developed by <a href="https://tngis.tn.gov.in/" target="_blank">TNeGA</a>
      </div>
    </footer>
    <!-- End Footer -->
    <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>
    <!-- Delete modal starts -->
    <div class="modal fade viewinfo" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
          <div class="modal-header py-2">
            <h1 class="modal-title fs-5" id="exampleModalLabel">View Informations</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="table-responsive cus-grid">
              <table class="table table-striped w-100 no-footer dataTable mt-3" id="tblViewBeneficiariesUpoloadList" aria-describedby="tblViewBeneficiariesUpoloadList_info">
                <thead>
                  <tr>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">S.No</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Beneficiaries ID</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Beneficiaries Name</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Aadhaar</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Payment Period</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Installement</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Payment Mode</th>
                    <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">Amount</th>
                    <!-- <th tabindex="0" aria-controls="tblViewBeneficiariesUpoloadList" aria-label="S.No: activate to sort column descending" aria-sort="ascending" scope="col">status</th> -->
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
            </div>
          </div>
          <div class="modal-footer py-2">
            <button type="button" class="btn btn-danger cbtn " data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
        <!-- view crop info ends -->
        <script src="assets/vendor/jquery/jquery.min.js"></script>
        <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="assets/js/main.js"></script>
        <script type="text/javascript" src="assets/vendor/jquery-validate/js/jquery.validate.min.js"></script>
    
    
        <!-- data table -->
        <script src="assets/vendor/datatable/jquery.dataTables.min.js"></script>
        <script src="assets/vendor/datatable/dataTables.bootstrap5.min.js"></script>
        <script type="text/javascript" src="assets/vendor/datatable/js/dataTables.js"></script>
        <script type="text/javascript" src="assets/vendor/datatable/js/dataTables.bootstrap4.js"></script>
        <script src="assets/vendor/datatables-buttons/js/dataTables.buttons.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/jszip.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/pdfmake.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/vfs_fonts.js"></script>
        <script src="assets/vendor/datatables-buttons/js/buttons.html5.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/buttons.print.min.js"></script>
        <script src="assets/vendor/datatables-buttons/js/buttons.colVis.min.js"></script>
        <script src="assets/vendor/sweetalert2/js/sweetalert.min.js"></script>
        <script src="assets/vendor/sweetalert2/js/sweetalert2.all.min.js"></script>
        <script src="assets/vendor/toggle/bootstrap-toggle.min.js"></script>
        <script src="assets/js/global.js"></script>
        <script src="assets/js/alpinejs_3_10_2.min.js" defer></script>
        <script src="assets/lang/reports.js"></script>
        <script src='https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js'></script>
        <!-- data table -->
    
    
    
    
    
        
        <!-- Main JS File -->
        
        <script src="assets/js/global.js"></script>
        <script src="assets/js/base64tojson.js"></script>
        <script src="assets/js/crypto-js.js"></script>
        <script src="assets/js/aes.js"></script>
      
    
        <script type="text/javascript" src="assets/vendor/toastr/toastr.min.js"></script>
        
        <!-- Crypto js -->
        <script src="assets/vendor/encryption/crypto-js.min.js"></script>
        <!-- Encryption js -->
        <script src="assets/vendor/encryption/Encryption.js"></script>
        <script src="assets/vendor/sweetalert2/js/sweetalert2.all.min.js"></script>
        
        
     
     <script type="text/javascript">
      
    
    
    
    var url = window.location.href;
    var page_url = url.split('/');
    var page = page_url[4];
    
    var userDataString = getCookie('payment_official');
    userDataString = JSON.parse(userDataString);
    $(document).ready(function () {
      $(document).on({
            //  ajaxStart: function () {
            //    $('#preloader').show();
            //   //  console.log('preloader is show');
            //  },
             ajaxStop: function () {
               $('#preloader').hide();
              //  console.log('preloader is show');
             }
           });
    
      $('.official').each(function (i, obj) {
        var href = obj.getAttribute("href");
        if (href == page) {
          obj.classList.add('active');
        } else {
          obj.classList.remove('active');
        }
      });
      // $('#preloader').hide();
     
      var userDataString = getCookie('payment_official');
      if (!userDataString) {
        $('#preloader').show();
        window.location.href = "login.html";
      }
      
      userDataString = JSON.parse(userDataString);
      $('#official_username').text(userDataString['first_name']);
      $('#UserID').val(userDataString['user_id']);
      window.loginUser_id = userDataString['user_id'];
      reloID = userDataString['role_id'];
      roleBasedPageAllow(loginUser_id,reloID);
      
      getSchemeCategory();
      getDistricts();
    
      $('#ddl_sub_scheme').on('change',function(){
       $('#ddl_department').empty();
       $('#ddl_sub_department').empty();
    
       $('#ddl_department').append($('<option>', {value: "",text: "--ALL--"}));
       $('#ddl_sub_department').append($('<option>', {value: "",text: "--ALL--"}));
        $('#preloader').show();
         $.ajax({
           url: APIURL +'schem_filter',
           type: "POST",
           headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
           data: {case: "get_department",scheme_code:$('#ddl_scheme_code').val(),scheme_name:$('#ddl_scheme_name').val(),sub_scheme_name:$('#ddl_sub_scheme').val(),user_id:loginUser_id},
           success: function(response) {
            $('#preloader').hide();
              //  console.log("department:", response);
              
               var department_code = response.data[0];
              //  console.log(department_code.department);
               getDepartment(department_code.department);
               dynamicFocusAndBlur('ddl_sub_scheme');
           },
           error: function(xhr, status, error) {
            $('#preloader').hide();
               console.log("Error:", error);
           }
         });
      });
    
      $('#ddl_district').on('change', function () {
        var district_code = $('#ddl_district').val();
        $('#ddl_taluk').empty();
        $('#ddl_taluk').append('<option value="">--ALL--</option>');
        getTaluk(district_code);
      });
    
    
    });
    
    function getCookie(name) {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.startsWith(name + '=')) {
            return cookie.substring(name.length + 1);
          }
        }
        return null;
      }
    
    /* filters */
    function getSchemeCategory(){
        
        $('#ddl_scheme_name').empty();
        $('#ddl_sub_scheme').empty();
        $('#ddl_department').empty();
        $('#ddl_sub_department').empty();
     
        $('#ddl_scheme_name').append($('<option>', {value: "", text: "--All--"}));
        $('#ddl_sub_scheme').append($('<option>', {value: "",text: "--All--"}));
        $('#ddl_department').append($('<option>', {value: "",text: "--All--"}));
        $('#ddl_sub_department').append($('<option>', {value: "",text: "--All--"}));
     
      $.ajax({
        url: APIURL +'schem_filter',
        type: "POST",
        headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
        data: {case: "get_scheme_category",get_column:"scheme_code",groupbycolumn:"scheme_code",user_id:loginUser_id},
        success: function(response) {
           //  console.log("Success:", response);
            var schemeCode = response.data;
           //  console.log('scheme code >>> ',schemeCode);
     
            $('#ddl_scheme_cate').empty();
            $('#ddl_scheme_cate').append($('<option>', {
                  value: "",
                  text: "--All--"
              }));
    
            $.each(schemeCode, function (index, scheme) {
                // console.log('scheem code lenthg >>> ', schemeCode.length);
                if(schemeCode.length >1){
                  $('#ddl_scheme_cate').append($('<option>', {
                    value: scheme.scheme_category,
                    text: scheme.scheme_category
                }));
                }else{
                  $('#ddl_scheme_cate').append($('<option>', {
                    value: scheme.scheme_category,
                    text: scheme.scheme_category
                }).prop('selected', true));
                $('#ddl_scheme_cate').trigger('change');
                }
             });
        },
        error: function(xhr, status, error) {
            console.log("Error:", error);
        }
      });
    }
    
    
    $('#ddl_scheme_cate').on('change',function(){
      
        $('#ddl_scheme_code').empty();
        $('#ddl_scheme_name').empty();
        $('#ddl_sub_scheme').empty();
        $('#ddl_department').empty();
        $('#ddl_sub_department').empty();
    
        $('#ddl_scheme_code').append($('<option>', {value: "", text: "--All--"}));
        $('#ddl_scheme_name').append($('<option>', {value: "", text: "--All--"}));
        $('#ddl_sub_scheme').append($('<option>', {value: "",text: "--All--"}));
        $('#ddl_department').append($('<option>', {value: "",text: "--All--"}));
        $('#ddl_sub_department').append($('<option>', {value: "",text: "--All--"}));
      
       $.ajax({
         url: APIURL +'schem_filter',
         type: "POST",
         headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
         data: {case: "get_scheme_code",get_column:"scheme_code",groupbycolumn:"scheme_code",whereColumn:$('#ddl_scheme_cate').val(),user_id:loginUser_id},
         success: function(response) {
            //  console.log("Success:", response);
             var schemeCode = response.data;
            //  console.log('scheme code >>> ',schemeCode);
      
             $('#ddl_scheme_code').empty();
             $('#ddl_scheme_code').append($('<option>', {
                   value: "",
                   text: "--All--"
               }));  
    
            $.each(schemeCode, function (index, scheme) {
                // console.log('scheem code lenthg >>> ', schemeCode.length);
                if(schemeCode.length >1){
                  $('#ddl_scheme_code').append($('<option>', {
                    value: scheme.scheme_code,
                    text: scheme.scheme_code
                }));
                }else{
                  $('#ddl_scheme_code').append($('<option>', {
                    value: scheme.scheme_code,
                    text: scheme.scheme_code
                }).prop('selected', true));
                $('#ddl_scheme_code').trigger('change');
                }
             });
         },
         error: function(xhr, status, error) {
             console.log("Error:", error);
         }
       });
    })
    
    
    
    $('#ddl_scheme_code').on('change',function(){
    
         $('#ddl_sub_scheme').empty();
         $('#ddl_scheme_name').empty();
         $('#ddl_sub_scheme').empty();
         $('#ddl_department').empty();
         $('#ddl_sub_department').empty();
    
         $('#ddl_sub_scheme').append($('<option>', {value: "",text: "--ALL--"}));
         $('#ddl_scheme_name').append($('<option>', {value: "", text: "--ALL--"}));
         $('#ddl_sub_scheme').append($('<option>', {value: "",text: "--ALL--"}));
         $('#ddl_department').append($('<option>', {value: "",text: "--ALL--"}));
         $('#ddl_sub_department').append($('<option>', {value: "",text: "--ALL--"}));
    
          $('#preloader').show();
       $.ajax({
       url: APIURL +'schem_filter',
       type: "POST",
       headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
       data: {case: "get_scheme",scheme_code:$('#ddl_scheme_code').val(),user_id:loginUser_id},
       success: function(response) {
        $('#preloader').hide();
          //  console.log("Success:", response);
           var schemeCode = response.data;
          //  console.log(schemeCode.scheme_code);
           $('#ddl_scheme_name').empty();
           $('#ddl_scheme_name').append($('<option>', {
                 value: "",
                 text: "--ALL--"
             }));
           // Iterate over the JSON object and append options
           $.each(schemeCode, function (index, scheme) {
            // console.log('scheem code lenthg >>> ', schemeCode.length);
            if(schemeCode.length >1){
              $('#ddl_scheme_name').append($('<option>', {
                 value: scheme.scheme_name,
                 text: scheme.scheme_name
             }));
            }else{
              $('#ddl_scheme_name').append($('<option>', {
                 value: scheme.scheme_name,
                 text: scheme.scheme_name
             }).prop('selected', true));
             $('#ddl_scheme_name').trigger('change');
             dynamicFocusAndBlur('ddl_scheme_code');
             
            }
             
    
           });
       },
       error: function(xhr, status, error) {
        $('#preloader').hide();
           console.log("Error:", error);
       }
     });

     
    });
    
    $('#ddl_scheme_name').on('change',function(){
       // $('#ddl_scheme_name').empty();
       $('#ddl_sub_scheme').empty();
       $('#ddl_department').empty();
       $('#ddl_sub_department').empty();
       
       // $('#ddl_scheme_name').append($('<option>', {value: "", text: "--ALL--"}));
       $('#ddl_sub_scheme').append($('<option>', {value: "",text: "--ALL--"}));
       $('#ddl_department').append($('<option>', {value: "",text: "--ALL--"}));
       $('#ddl_sub_department').append($('<option>', {value: "",text: "--ALL--"}));
    
    $('#preloader').show();
      $.ajax({
       url: APIURL +'schem_filter',
       type: "POST",
       headers: {'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
       data: {case: "get_sub_scheme",scheme_code:$('#ddl_scheme_code').val(),scheme_name:$('#ddl_scheme_name').val(),user_id:loginUser_id},
       success: function(response) {
            $('#preloader').hide();
            //  console.log("Success:", response);
           var schemeCode = response.data;
            //  console.log(schemeCode.scheme_code);
           $('#ddl_sub_scheme').empty();
           $('#ddl_sub_scheme').append($('<option>', {
                 value: "",
                 text: "--ALL--"
             }));
           // Iterate over the JSON object and append options
           $.each(schemeCode, function (index, scheme) {
            if(schemeCode.length > 1){
              $('#ddl_sub_scheme').append($('<option>', {
                 value: scheme.subscheme_name,
                 text: scheme.subscheme_name
             }));
            }else{
              $('#ddl_sub_scheme').append($('<option>', {
                  value: scheme.subscheme_name,
                  text: scheme.subscheme_name
              }).prop('selected', true));
            }
            $('#ddl_sub_scheme').trigger('change');
            dynamicFocusAndBlur('ddl_scheme_name');
           });
       },
       error: function(xhr, status, error) {
        $('#preloader').hide();
           console.log("Error:", error);
       }
     });
    
    });
    
    // get_scheme
    
    
    /* filters */
    function getDepartment(depID){
       $('#ddl_department').empty();
       $('#ddl_sub_department').empty();
    
       $('#ddl_department').append($('<option>', {value: "",text: "--ALL--"}));
       $('#ddl_sub_department').append($('<option>', {value: "",text: "--ALL--"}));
        $('#preloader').show();
    $.ajax({
       url: APIURL +'get_department',
       type: "POST",
       headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
       data: {type: "department"},
       success: function(response) {
           // console.log("Success:",JSON.parse(response)[0].data );
           var department = response[0].data;
           // Handle the successful response here
           $('#ddl_department').empty();
           $('#ddl_department').append($('<option>', {
                 value: "",
                 text: "--ALL--"
             }));
           // Iterate over the JSON object and append options
           $.each(department, function (index, dep) {
             if(dep.department_code==depID){
               $('#ddl_department').append($('<option>', {
                 value: dep.department_code,
                 text: dep.department_name
               }).attr('selected', 'selected'));
               // $('#ddl_department').trigger('change');
    
               $.ajax({
                     url: APIURL +'schem_filter',
                     type: "POST",
                     headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
                     data: {case: "get_sub_department",scheme_code:$('#ddl_scheme_code').val(),scheme_name:$('#ddl_scheme_name').val(),sub_scheme_name:$('#ddl_sub_scheme').val(),department:$('#ddl_department').val(),user_id:loginUser_id},
                     success: function(response) {
                      $('#preloader').hide();
                      dynamicFocusAndBlur('ddl_department');
                        //  console.log("department:", response);
                         var subdepartment_code = response.data[0];
                        //  console.log(subdepartment_code.department);
                         get_sub_department(dep.department_code,subdepartment_code.subdepartment);
                         
                     },
                     error: function(xhr, status, error) {
                      $('#preloader').hide();
                         console.log("Error:", error);
                     }
                 });
           
             }
           });
       },
       error: function(xhr, status, error) {
           console.log("Error:", error);
           // Handle the error here
       }
     });
    }
    
    
    // $('#ddl_department').on('change',function(){
     function get_sub_department(depID,subDepID){
       $('#ddl_sub_department').empty();
       $('#ddl_sub_department').append($('<option>', {value: "",text: "--ALL--"}));
        $('#preloader').show();
         // var department = $('#ddl_department').val();
         $.ajax({
         url: APIURL +'get_department',
         type: "POST",
         headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
         data: {type: "sub_department",department_code:depID},
         success: function(response) {
          $('#preloader').hide();
             // console.log("Success:",JSON.parse(response)[0].data );
             var department = response[0].data;
             // Handle the successful response here
             $('#ddl_sub_department').empty();
             $('#ddl_sub_department').append($('<option>', {
                   value: "",
                   text: "--ALL--"
               }));
             // Iterate over the JSON object and append options
             $.each(department, function (index, sub_dep) {
               if(sub_dep.sub_department_code==subDepID){
                 $('#ddl_sub_department').append($('<option>', {
                   value: sub_dep.sub_department_code,
                   text: sub_dep.sub_department_name
               }).attr('selected', 'selected'));
               }
             });
             dynamicFocusAndBlur('ddl_sub_department');

         },
         error: function(xhr, status, error) {
          $('#preloader').hide();
             console.log("Error:", error);
             // Handle the error here
         }
       });
       importDataStatus();
       uploadSchemeBasedLoadTable();
      }
    
      function getDistricts(){
          const userDataString = getCookie("payment_official");
          const userData = JSON.parse(userDataString);
    
          var districtID=0;
          var data=[];
          if(userData['district_code']!=0){
          districtID=userData['district_code'];
          data={ case: 'district',district_code: districtID,user_id:userData['user_id']};
          } else {
          data={ case: 'district',user_id:userData['user_id']};
          }
    
          $('#ddl_taluk').empty();
          $('#ddl_taluk').append('<option value="">--ALL--</option>');
          $('#preloader').show();
        $.ajax({
          url: userMasterAPIURL+'userMaster',
          method: 'POST',
          headers: {'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
          data: data,
          dataType: 'json',
          success: function (response) {
            $('#preloader').hide();
            //console.log(response);
            var district = response.district;
            var districtDropdown = $("#ddl_district");
            $('#ddl_district').empty();
            $('#ddl_district').append($('<option>', {value: "",text: "--ALL--"}));
              
            if(districtID==0 || districtID ==undefined){
            populateDropdown('ddl_district', response.districts, 'district');              
            } else {
            districtDropdown.html('<option value="'+district['district_code']+'">'+district['district_name']+'</option>');
            $('#ddl_district').trigger('change');
            var district_code= district['district_code'];
              getTaluk(district_code);
            } 
          },
          error: function () {
            $('#preloader').hide();
            console.error('Error fetching district data');
          }
        });
      }
    
    
      
    
      /*START : Get Taluk list*/
      function getTaluk(districtID){
        $('#ddl_taluk').empty();
        $('#ddl_taluk').append('<option value="">--ALL--</option>');
        // var district=$("#ddl_district").val();
          const userDataString = getCookie("payment_official");
          const userData = JSON.parse(userDataString);
    
          // var district=district_code;
          var talukID=0;
          var data=[];
          if(userData['taluk_code']!=0){
          // districtID=userData['district_code'];
          talukID=userData['taluk_code'];
          data={ case: 'taluk',district_code: districtID,taluk_code: talukID,user_id:userData['user_id']};
          } else {
          data={ case: 'taluk',district_code: districtID,user_id:userData['user_id']};
          }
          $('#preloader').show();
        
        $.ajax({
          url: userMasterAPIURL+'userMaster', // Replace with your API endpoint
          method: 'POST',
          headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
          data: data,
          dataType: 'json',
          success: function (response) {
            $('#preloader').hide();
            /*$('#ddl_taluk').empty();
            $.each(response.taluk, function (index, value) 
            {
                $('#ddl_taluk').append('<option value="' + value.taluk_code + '">' + value.taluk_name + ' </option>');
            });*/
            var taluk = response.taluk
            var talukDropdown = $("#ddl_taluk");
          //  populateDropdown('ddl_taluk', response.taluk, 'taluk'); 
            if(talukID==0){
              populateDropdown('ddl_taluk', response.taluk, 'taluk');             
            } else {
              
              talukDropdown.html('<option value="'+taluk['taluk_code']+'">'+taluk['taluk_name']+'</option>');
            $('#ddl_taluk').trigger('change');
            }
          },
          error: function () {
            $('#preloader').hide();
            Swal.fire({
              icon: "error",
              title: "Service Error!",
              showConfirmButton: false,
              timer: 2000
            })
          }
        });
      }
    
      $("#from_date").prop("disabled", true);
      $("#to_date").prop("disabled", true);
    
    $('#dayWeekMonthFilter').on('change',function(){
        var payment_period = $('#dayWeekMonthFilter').val();
        if(payment_period == 0){
          // console.log(payment_period);
          $("#from_date").prop("disabled", false);
          $("#to_date").prop("disabled", false);
        }else{
          $("#from_date").val('');
          $("#from_date").prop("disabled", true);
          $("#to_date").val('');
          $("#to_date").prop("disabled", true);
        }
    });
    
    
    $('#to_date').on('change', function() {
        $('#today').prop('checked', false);
        $('#thisweek').prop('checked', false);
        $('#thismonth').prop('checked', false);
        var fromDate = $('#from_date').val();
        var toDate = $(this).val();
        // Check if "to_date" is earlier than "from_date"
        if (fromDate && toDate && fromDate > toDate) {
          alert('To Date should not be earlier than From Date.');
          // You can reset the "to_date" value or take other actions here
          $(this).val('');
        }
    });
    
      $('#paymentDate').on('change', function() {
        var todayDate = new Date(); 
        todayDate.setDate(todayDate.getDate() - 1);
        var toDate = new Date($(this).val());
        if (toDate < todayDate) {
            alert('To Date should be a future date.');
            $(this).val('');
        }
        $('#paymentDate_error').hide();
      });
    
    
    
      $("#credited_from_date").prop("disabled", true);
      $("#credited_to_date").prop("disabled", true);
    
    $('#crediteddayWeekMonthFilter').on('change',function(){
        var payment_period = $('#crediteddayWeekMonthFilter').val();
        if(payment_period == 0){
          // console.log(payment_period);
          $("#credited_from_date").prop("disabled", false);
          $("#credited_to_date").prop("disabled", false);
        }else{
          $("#credited_from_date").val('');
          $("#credited_from_date").prop("disabled", true);
          $("#credited_to_date").val('');
          $("#credited_to_date").prop("disabled", true);
        }
    });
    
    
    $('#credited_to_date').on('change', function() {
        $('#today').prop('checked', false);
        $('#thisweek').prop('checked', false);
        $('#thismonth').prop('checked', false);
        var fromDate = $('#credited_from_date').val();
        var toDate = $(this).val();
        // Check if "to_date" is earlier than "from_date"
        if (fromDate && toDate && fromDate > toDate) {
          alert('To Date should not be earlier than From Date.');
          // You can reset the "to_date" value or take other actions here
          $(this).val('');
        }
    });
    
      /*END : Get Taluk list*/
    // });
    
    var formsFilter = [];
    window.localStorage.removeItem('filters');
    let failedrecordCount = 0;
    let uploadFile = 0;
    /*from submit*/
    $(document).ready(function() {
      $("#beneficiaryUploadForm").validate({
              rules: {
                  ddl_scheme_cate : {required: true},
                  ddl_scheme_code : {required: true},
                  ddl_scheme_name : {required: true},
                  ddl_sub_scheme : {required: true},
                  ddl_department : {required: true},
                  ddl_sub_department : {required: true},
                  // ddl_district : {required: true},
                  // ddl_taluk : {required: true},
                  ddl_month : {required: true},
                  ddl_year : {required: true},
                  beneficiary_csv_file : {required: true},
              },
              messages: {
                ddl_scheme_cate: {required: "Select the Scheme Category"},
                ddl_scheme_code: {required: "Select the Scheme Code"},
                ddl_scheme_name: {required: "Select the scheme Name"},
                ddl_sub_scheme: {required: "Select the Sub Scheme Name"},
                ddl_department: {required: "Select the Deparment"},
                ddl_sub_department: {required: "Select the Sub Deparment"},
                // ddl_district: {required: "Select the District"},
                // ddl_taluk: {required: "Select the Taluk"},
                ddl_month : {required: "Select the Month"},
                ddl_year : {required: "Select the Year"},
                beneficiary_csv_file : {required: "Select the Upload must csv file"},
              },
              errorClass: "help-inline text-danger",
              errorElement: "span",
              highlight: function(element, errorClass, validClass) {
                  $(element).parents('.form-group').addClass('has-error');
              },
              unhighlight: function(element, errorClass, validClass) {
                  $(element).parents('.form-group').removeClass('has-error');
                  $(element).parents('.form-group').addClass('has-success');
              },
              submitHandler: function(form,e) {
                  e.preventDefault();
                  const uniqueId = generateUniqueId();
                  // console.log(uniqueId);
                  
                  window.localStorage.setItem('upload_reference_id', uniqueId);

                  var formData = new FormData(form);
                  // console.log(formData);
                  
                  // getFileEncoded().then(base64Encoded => {
                  //   console.log(base64Encoded);
                  //   formData.append('encodedFile[]', base64Encoded);
                  // });

                  formData.append('upload_reference_no', uniqueId);

                  window.localStorage.removeItem('filters');
                  window.localStorage.setItem('filters', JSON.stringify($(form).serialize()));

                    // $('#preloader').show();
                    $.ajax({
                      type: 'POST',
                      headers: { 'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
                      url: APIURL + 'beneficiaries_upload',
                      data: formData,
                      processData: false,  // Don't process the data
                      contentType: false,  // Don't set content type
                      success: function(response) {
                      // Handle success
                      // console.log('banificiaries upload >>>>> ',response);
                    // $('#preloader').hide();
                    if(response.success == 1){
                      // failedrecordCount = response.recordsFailed;
                      Swal.fire({
                            icon: "success",
                            title: 'Beneficiaries Data Updated',
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }else{
                      uploadFile = 2;
                      Swal.fire({
                          icon: "error",
                          title: response.message,
                          showConfirmButton: false,
                          timer: 2000
                      });
                    }
                    
                    },
                    error: function(xhr, status, error) {
                    // Handle error
                    // $('#preloader').hide();
                        Swal.fire({
                          icon: "error",
                          title: 'Service Error !',
                          showConfirmButton: false,
                          timer: 2000
                      });
                    }
                    });

                      var importDataCount = window.localStorage.getItem('importDataCount');
                      
                      var form = document.getElementById("beneficiaryUploadForm");
                      var formData = new FormData(form);

                      var formDatasAdd = {};
                        formData.forEach(function(value, key){
                          if('beneficiary_csv_file'!=key){
                            formDatasAdd[key] = value;
                          }
                      });
                      var existingData = JSON.parse(localStorage.getItem("importDataArray")) || [];

                      var importArr = {
                          "schemes_filters": formDatasAdd,
                          "importDataCount": importDataCount,
                          "upload_reference_no": uniqueId,
                          "completed":false
                        };

                        // Push new data to the array
                        existingData.push(importArr);
                        
                        // Store the updated array back in local storage
                        localStorage.setItem("importDataArray", JSON.stringify(existingData));
                      
                      
                      $("#uploadBtn").prop("disabled", true);
                        // console.log('formData array print', importArr);
                        // $('#div_report_tbl').show();
                        importDataStatus();
                  return false;
              }
        });
    });

/*get set Item*/
$('#div_report_tbl').hide();



function importDataStatus() {

  // console.log('uploaded file failed check', uploadFile);
  


  let importDatas = window.localStorage.getItem('importDataArray');
  let expactValidate = {};
  let valueKeyCheck = ['ddl_scheme_cate', 'ddl_scheme_code', 'ddl_scheme_name', 'ddl_sub_scheme', 'ddl_department', 'ddl_sub_department'];

 



    // Populate expactValidate object with values from form elements
    valueKeyCheck.forEach(function (key) {
      expactValidate[key] = $('#' + key).val();
    });

    // console.log('Expected file input values >>', expactValidate);
    let fileImportID = 0;
    let fileRecordTotalCount = 0;
    let getIndex = null;
    let currentImportingSchemeName = null;

  if (importDatas != null) {
    let importDatasArr = JSON.parse(importDatas);
    // console.log('Convert to array >> ', importDatasArr);

    importDatasArr.forEach((importData, index) => {
      let schemeFilters = importData.schemes_filters;
      if(importData.completed === false){
        valueKeyCheck.forEach(function (key) {
          if(schemeFilters[key] === expactValidate[key]){
            // console.log('import data list ',importData.upload_reference_no);
              fileImportID = importData.upload_reference_no;
              fileRecordTotalCount =  importData.importDataCount;
              currentImportingSchemeName = schemeFilters['ddl_sub_scheme'];
              // $('#div_report_tbl').show();
          }
        });
      }
    });

    // console.log('scheme Based fileImportID >>> ', fileImportID);
    // console.log('scheme Based fileRecordTotalCount >>> ', fileRecordTotalCount);

  if(uploadFile == 2){
    //failed uploaded error
    if (importDatas != null) {
    let importDatasArr = JSON.parse(importDatas);
        const entryToMarkAsCompleted = importDatasArr.find(list => list.upload_reference_no == fileImportID);
        if (entryToMarkAsCompleted) {
          entryToMarkAsCompleted.completed = true;
          localStorage.setItem('importDataArray', JSON.stringify(importDatasArr));
        }
    }
    $("#uploadBtn").prop("disabled", false);
    $('#importing_status').empty();
    return false;
  }


    if(fileImportID != 0 && fileRecordTotalCount!=0){
      $.ajax({
        url: APIURL + 'importDataStatus',
        method: 'POST',
        headers: {'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
        data: {
        upload_reference_no: fileImportID
        },
        dataType: 'json',
        success: function (response) {
            if(response.success==true){
              let output = response.data;
              let importCountMessage=``;

              if(output.count !== 0){
                importCountMessage = `<span class="badge text-primary c-pointer pulse d-inline" id="transfer_payment_status" ><i class="bi bi-pencil-square"></i> ${currentImportingSchemeName} is Import in progress: ${output.count}  out of ${fileRecordTotalCount} completed</span>`;
              }else{
                importCountMessage = `<span class="badge text-primary c-pointer pulse d-inline" id="transfer_payment_status" ><i class="bi bi-pencil-square"></i> ${currentImportingSchemeName} From Initiated Beneficiary Upload</span>`;
              }
            

              $('#importing_status').html(importCountMessage);
              $("#uploadBtn").prop("disabled", true);

              let convertTotalInt = parseInt(fileRecordTotalCount);//+ failedrecordCount;
             
              if(output.count <= convertTotalInt &&  output.count != convertTotalInt){
                setTimeout(function() {importDataStatus();}, 3000);       
              }else{
                //this completed status update based trackingID
                if (importDatas != null) {
                let importDatasArr = JSON.parse(importDatas);
                    const entryToMarkAsCompleted = importDatasArr.find(list => list.upload_reference_no == fileImportID);
                    if (entryToMarkAsCompleted) {
                      entryToMarkAsCompleted.completed = true;
                      localStorage.setItem('importDataArray', JSON.stringify(importDatasArr));
                    }
                }


                $('#beneficiaryUploadForm')[0].reset();
                $('#importing_status').empty();
                let importCountMessage = `<span class="badge text-success c-pointer pulse d-inline" id="transfer_payment_status" ><i class="bi bi-pencil-square"></i> File Import completed</span>`;

                uploadSchemeBasedLoadTable();

                $('#importing_status').html(importCountMessage);
                setTimeout(function() {
                  $("#uploadBtn").prop("disabled", false);
                  $('#importing_status').empty();
                }, 3000);
              }
            }else{
              $("#uploadBtn").prop("disabled", false);
              $('#importing_status').empty();
            }
        },
        error: function (xhr, status, error) {
            // Handle error
            $("#uploadBtn").prop("disabled", false);
              $('#importing_status').empty();
            Swal.fire({
                icon: "error",
                title: 'Service Error!',
                showConfirmButton: false,
                timer: 2000
            });
        }
      });
    }else{
        $("#uploadBtn").prop("disabled", false);
        $('#importing_status').empty();
    }
    //$("#uploadBtn").prop("disabled", true);

  } else {
    // console.log('Enable/disable boolean >>>', $("#uploadBtn").prop("disabled"));
    if ($("#uploadBtn").prop("disabled") == true) {
      // console.log('else path is working import file status');
        $("#uploadBtn").prop("disabled", false);
        $('#importing_status').empty();
    }
  }
  // console.log('Import data arrays >>', importDatas);
}

$("#beneficiary_csv_file").on("change", function() {
    var fileInput = this;
    
      const maxSize = 200 * 1024 * 1024;
      // const maxSize = 200 * 200 * 200;
      // console.log('max size ',maxSize);
      // console.log('file max size ',fileInput.files[0].size);
      // console.log(fileInput.files[0].size > maxSize);
      if (fileInput.files[0].size > maxSize) {
          Swal.fire({
            icon: "error",
            title: 'File size exceeds 200 MB. The allowed limit !',
            showConfirmButton: false,
            timer: 4000
          });
          
          fileInput.value = ''; // Clear the file input
      }else{
        if(fileInput.files.length!=0){
            $('#preloader').show();
        }
        if (fileInput.files.length > 0) {
          var file = fileInput.files[0];
          var reader = new FileReader();
          reader.onload = function(e) {
              var lines = e.target.result.split("\n");
              var totalRows = lines.length - 2; // Subtract 1 if there is a header
              window.localStorage.setItem('importDataCount', totalRows);
              console.log("Total Rows: " + totalRows);
              $('#preloader').hide();
          };

          reader.readAsText(file);
        }
      }

});

    
    
    function populateDropdown(dropdownId, data, fieldName) {
        const dropdown = document.getElementById(dropdownId);
    
        // Clear existing options
        //dropdown.innerHTML = '<option value="">--ALL--</option>';
    
        // Populate options from data
        data.forEach(item => {
          const option = document.createElement('option');
          option.value = item[fieldName + '_code'];
          option.textContent = item[fieldName + '_name'];
          dropdown.appendChild(option);
        });
      }
    
    
    
      $('#selectAllCheckbox').on('change', function () {
        // console.log($(this).prop('checked'));
          $('tbody :checkbox').prop('checked', $(this).prop('checked'));
      });
    
      
      $('#selectAllCheckbox2').on('change', function () {
        // console.log($(this).prop('checked'));
          $('tbody :checkbox').prop('checked', $(this).prop('checked'));
      });
    
      $('#selectAllCheckbox3').on('change', function () {
        // console.log($(this).prop('checked'));
          $('tbody :checkbox').prop('checked', $(this).prop('checked'));
      });
    
    
    
    
    
    let checkValue = window.localStorage.getItem('bulkApprvelstatustrigger');
    
    // if (checkValue != undefined && checkValue != '' && checkValue == 0) {
      //  intervalId = setInterval(getCurrentBulkApprovalCount, 3000);
    // }
    intervalId = 1;
    // setTimeout(function() {getCurrentBulkApprovalCount();},200);
    
    $('#progress_strat').hide();
    $('#selectApprovalBtn').hide();
    $('#bulkApprovalBtn').hide();
    $('#progress_strat').hide();
    
    var showColletionData = true;
    
   
    
    function generateUniqueId() {
      const timestamp = new Date().getTime();
      // const random = Math.floor(Math.random() * 1000); // Adjust the range as needed
      return `${timestamp}`;//${random}
    }
    
    
    function tblPreloaderEnable(tableName){
          var processingDiv = document.getElementById(tableName+'_processing');
          var displayStatus = window.getComputedStyle(processingDiv).display;
          if (displayStatus === 'block') {
          $('#'+tableName+'_processing').html(`<div id="preloader"></div>`);
          } else {
            $('#'+tableName+'_processing').text(`<div id="preloader"></div>`);
          }
    }
    
    
    function uploadSchemeBasedLoadTable(){
        let importDatas = window.localStorage.getItem('importDataArray');
        let expactValidate = {};
        let valueKeyCheck = ['ddl_scheme_cate', 'ddl_scheme_code', 'ddl_scheme_name', 'ddl_sub_scheme', 'ddl_department', 'ddl_sub_department'];

        // Populate expactValidate object with values from form elements
        valueKeyCheck.forEach(function (key) {
        expactValidate[key] = $('#' + key).val();
        });

        // console.log('Expected file input values >>', expactValidate);
        let fileImportID = 0;
        let fileRecordTotalCount = 0;
        let getIndex = null;
        let currentImportingSchemeName = null

        if (importDatas != null) {
        let importDatasArr = JSON.parse(importDatas);
        // console.log('Convert to array >> ', importDatasArr);

        importDatasArr.forEach((importData, index) => {
        let schemeFilters = importData.schemes_filters;
            valueKeyCheck.forEach(function (key) {
                if(schemeFilters[key] === expactValidate[key]){
                    fileImportID = importData.upload_reference_no;
                    fileRecordTotalCount =  importData.importDataCount;
                    currentImportingSchemeName = schemeFilters['ddl_sub_scheme'];
                }
              });
          });

        // console.log('scheme Based fileImportID >>> ', fileImportID);
        // console.log('scheme Based fileRecordTotalCount >>> ', fileRecordTotalCount);

        if(fileImportID != 0 && fileRecordTotalCount!=0){
          uploadBeneficiariesList(fileImportID);
        }else{
          $("#uploadBtn").prop("disabled", false);
          $('#importing_status').empty();
        }
        } else {
        // console.log('Enable/disable boolean >>>', $("#uploadBtn").prop("disabled"));
        if ($("#uploadBtn").prop("disabled") == true) {
        // console.log('else path is working import file status');
        $("#uploadBtn").prop("disabled", false);
        $('#importing_status').empty();
        }
        }        
    }


    
    var generate_payment_enable = window.localStorage.getItem('generate_payment_enable');
    var transfer_payment_enable = window.localStorage.getItem('transfer_payment_enable');
 

  function downloadFile() {
      var filePath = "assets/download/beneficiary/beneficiaries-upload.csv";
      var fileName = filePath.split('/').pop();
      var link = document.createElement('a');
      link.href = filePath;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
  }

  $(document).ready(function() {
    $('#ddl_year').on('change', function() {
      // alert($(this).val());
      var selectedYear = $(this).val();
      var currentDate = new Date();
      var currentYear = currentDate.getFullYear();

      // alert(parseInt(selectedYear) === currentYear);
      // alert(currentYear);

      var currentMonth = currentDate.getMonth() + 1;

       var getAllMonth = getAllMonthData();
      //  console.log('get all month', getAllMonth);

      $('#ddl_month option').prop('disabled', false);
      if (selectedYear <= currentYear) {
        $('#ddl_month option:lt(' + (currentMonth - 1) + ')').prop('disabled', true);
      }
    });
  });

  function getAllMonthData(){
    var returnMonthValue = $('#ddl_month option').map(function() {
      return $(this).val();
    }).get();

    return returnMonthValue;
  }

function uploadBeneficiariesList(fileImportID){

  let importDataArray = JSON.parse(window.localStorage.getItem('importDataArray'));
  let targetArray = [];
  targetArray = importDataArray.find(item => item.upload_reference_no === fileImportID);
  var dataFilters = JSON.stringify(targetArray);
  var userDataString = getCookie('payment_official');
  userDataString = JSON.parse(userDataString);
  window.loginUser_id = userDataString['user_id'];

    $('#preloader').show();

    $('#tblBeneficiariesUpoloadList').DataTable().clear().destroy();
    $('#tblBeneficiariesUpoloadList').DataTable({
        "aLengthMenu": [10, 25, 50,100],
        "pageLength": -1,
        "footer": true,
        "dom": 'Bfrtip',
        "buttons": [
          {
                extend: 'csv',
                text: 'CSV',
                filename: 'Payment Reports'
            },
            {
                extend: 'excel',
                text: 'Excel',
                filename: 'Payment Reports'
            }
          ],
        "searching": true,
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": APIURL + 'beneficiaries_upload_list',
            "type": "POST",
            "headers": {'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
            "dataType": "JSON",
            data: {
              fileters:dataFilters,
              upload_reference_no:fileImportID,
              user_id:loginUser_id
            },
          "beforeSend": function () {
            // $('#preloader').show();
            tblPreloaderEnable('tblBeneficiariesUpoloadList');
          },
          "error": function (xhr, error, thrown) {
                Swal.fire({
                    icon: "error",
                    title: 'Service Error !',
                    showConfirmButton: false,
                    timer: 2000
                });
            },
            "dataSrc": 'data',
          },
        "columns": [
            { "data": "S.No", render: function (data, type, row, meta) {
                return meta.row + meta.settings._iDisplayStart + 1;
                }
            },
            
            { "data": "district_name"},
            { "data": "taluk_name" },
            { "data": function (data, type, row, meta) {
              var result = splitYearMonth(data.yyyymm);
              return result.year;
             }
            },
            { "data": function (data, type, row, meta) {
              var result = splitYearMonth(data.yyyymm);
              return result.monthWords;
             }
            },
            { "data": "apb_beificiaries_count"},
            { "data": "apb_beificiaries_amount"},
            { "data": "ach_beificiaries_count"},
            { "data": "ach_beificiaries_amount"},
            { "data": "total_beificiaries_count"},
            { "data": "total_beificiaries_amount"},
            { "data": function (data, type, row, meta) {
            return '<a onclick="viewUploadBeneficiaries('+data.district_code+','+data.taluk_code+','+fileImportID+')" data-bs-toggle="modal" data-bs-target=".viewinfo" class="badge text-bg-warning c-pointer"><i class="bi bi-eye"></i> View </span></span>';
            }
            },
            // Add more columns as needed
            // Example: { "data": "complaint_raised_by" },
        ],
        "drawCallback": function (settings) {
            // Your drawCallback logic goes here
            // For example, updating dropdowns or other elements after the table is drawn
        },
        "initComplete": function (settings, json) {
          // $('#preloader').show();
            window.totalgetReportRecords = json.recordsTotal;
          $('#btnfilter').click();
          // console.log('total loading  record ', totalgetReportRecords);
          // console.log(totalgetReportRecords > 0);
          if(totalgetReportRecords > 0){
            $('#div_report_tbl').show();
            $('#preloader').hide();
          }
          else{
            $('#div_report_tbl').hide();
            $('#preloader').hide();
          }
        }
    });
}


function splitYearMonth(yearmonth) {
    var yearmonthString = yearmonth.toString();
    var year = parseInt(yearmonthString.substring(0, 4), 10);
    var monthNumeric = parseInt(yearmonthString.substring(4, 6), 10);
    var monthWords = getMonthWord(monthNumeric);
    return {
        year: year,
        monthNumeric: monthNumeric,
        monthWords: monthWords
    };
}

function getMonthWord(monthNumeric) {
    var monthNames = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];
    if (monthNumeric >= 1 && monthNumeric <= 12) {
        return monthNames[monthNumeric - 1];
    } else {
        return "Invalid Month";
    }
}

// $('#div_report_tbl').hide();




function viewUploadBeneficiaries(district_code, taluk_code,fileImportID){

  let importDataArray = JSON.parse(window.localStorage.getItem('importDataArray'));
  let targetArray = [];
  targetArray = importDataArray.find(list => list.upload_reference_no == fileImportID);
  var dataFilters = JSON.stringify(targetArray);

  // console.log('importDataArray ', fileImportID);
  // console.log('importDataArray ', importDataArray);
  // console.log('targetArray ', targetArray);
  // console.log('dataFilters ', dataFilters);



  var userDataString = getCookie('payment_official');
  userDataString = JSON.parse(userDataString);
  window.loginUser_id = userDataString['user_id'];

    $('#preloader').show();

    $('#tblViewBeneficiariesUpoloadList').DataTable().clear().destroy();
    $('#tblViewBeneficiariesUpoloadList').DataTable({
        "aLengthMenu": [10, 25, 50,100],
        "pageLength": 50,
        "footer": true,
        "dom": 'Bfrtip',
        "buttons": [
          {
                extend: 'csv',
                text: 'CSV',
                filename: 'Payment Reports'
            },
            {
                extend: 'excel',
                text: 'Excel',
                filename: 'Payment Reports'
            }
          ],
        "searching": true,
        "processing": true,
        "serverSide": true,
        "ajax": {
            "url": APIURL + 'view_beneficiaries_upload_list',
            "type": "POST",
            "headers": {'X-APP-KEY': config.app_key, 'X-APP-NAME': config.app_name },
            "dataType": "JSON",
            data: {
              fileters:dataFilters,
              districtCode : district_code,
              talukCode : taluk_code,
              // upload_reference_no:fileImportID,
              user_id:loginUser_id
            },
          "beforeSend": function () {
            // $('#preloader').show();
            tblPreloaderEnable('tblViewBeneficiariesUpoloadList');
          },
          "error": function (xhr, error, thrown) {
                Swal.fire({
                    icon: "error",
                    title: 'Service Error !',
                    showConfirmButton: false,
                    timer: 2000
                });
            },
            "dataSrc": 'data',
          },
        "columns": [
            { "data": "S.No", render: function (data, type, row, meta) {
                return meta.row + meta.settings._iDisplayStart + 1;
                }
            },
            
            { "data": "benificiary_id"},
            { "data": "benificiary_name" },
            { "data": "adhaar_no" },
            { "data": "yyyymm" },
            { "data": "installment_id" },
            { "data": "payment_mode" },
            { "data": "amount" },
           
            // Add more columns as needed
            // Example: { "data": "complaint_raised_by" },
        ],
        "drawCallback": function (settings) {
            // Your drawCallback logic goes here
            // For example, updating dropdowns or other elements after the table is drawn
        },
        "initComplete": function (settings, json) {
         $('#preloader').hide(); 
            window.totalgetReportRecords = json.recordsTotal;
          $('#btnfilter').click();
        }
    });
}
function dynamicFocusAndBlur(elementId){
  $('#'+elementId).focus();
  $('#'+elementId).blur();
}
    </script>
    </body>
    </html>